{
  "active": true,
  "connections": {
    "Execute Workflow": {
      "main": [
        [
          {
            "node": "Поиск пользователя",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Set",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Создание контакта": {
      "main": [
        [
          {
            "node": "ID контакта",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры контакта": {
      "main": [
        [
          {
            "node": "Создание контакта",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ID контакта": {
      "main": [
        [
          {
            "node": "Добавление пользователя",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Поиск пользователя": {
      "main": [
        [
          {
            "node": "Результат поиска",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Результат поиска": {
      "main": [
        [
          {
            "node": "Пользователь не найден?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Добавление пользователя": {
      "main": [
        [
          {
            "node": "Данные пользователя",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Идентификатор созданого": {
      "main": [
        [
          {
            "node": "ID пользователя",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Идентификатор найденного": {
      "main": [
        [
          {
            "node": "ID пользователя",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ID пользователя": {
      "main": [
        [
          {
            "node": "Покупка шаблона?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Если демо контакт не существует",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Товары": {
      "main": [
        [
          {
            "node": "Параметры создания сделки",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры создания сделки": {
      "main": [
        [
          {
            "node": "Создание сделки",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Создание сделки": {
      "main": [
        [
          {
            "node": "Ответ создания",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ответ создания": {
      "main": [
        [
          {
            "node": "Параметры связывания контакта",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Пользователь не найден?": {
      "main": [
        [
          {
            "node": "Параметры контакта",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Идентификатор найденного",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры связывания контакта": {
      "main": [
        [
          {
            "node": "Связывание сделки и контакта",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Покупка шаблона?": {
      "main": [
        [
          {
            "node": "Товары",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ID формы обращения",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Связывание сделки и контакта": {
      "main": [
        [
          {
            "node": "Параметры товара",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Список товаров": {
      "main": [
        [
          {
            "node": "SplitInBatches",
            "type": "main",
            "index": 0
          },
          {
            "node": "Параметры счета",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры привязки товара": {
      "main": [
        [
          {
            "node": "Привязка товара",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Привязка товара": {
      "main": [
        [
          {
            "node": "Параметры письма",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры письма": {
      "main": [
        [
          {
            "node": "Отправка письма",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Отправка письма": {
      "main": [
        [
          {
            "node": "Параметры myBI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры myBI": {
      "main": [
        [
          {
            "node": "Отправка webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Отправка webhook": {
      "main": [
        [
          {
            "node": "SplitInBatches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры счета": {
      "main": [
        [
          {
            "node": "Создание счета",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Создание счета": {
      "main": [
        [
          {
            "node": "Счет",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Счет": {
      "main": [
        [
          {
            "node": "Сделка и счет",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Сделка и счет": {
      "main": [
        [
          {
            "node": "Связь счета и сделки",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Связь счета и сделки": {
      "main": [
        [
          {
            "node": "Параметры обновления сделки",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры обновления сделки": {
      "main": [
        [
          {
            "node": "Обновление сделки",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ID формы обращения": {
      "main": [
        [
          {
            "node": "ID пользователя определен?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ID пользователя определен?": {
      "main": [
        [
          {
            "node": "Поиск автора",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Поиск автора": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры  сделки": {
      "main": [
        [
          {
            "node": "Новая сделка",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Новая сделка": {
      "main": [
        [
          {
            "node": "Данные о сделке",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Данные о сделке": {
      "main": [
        [
          {
            "node": "Сделка и контакт",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Сделка и контакт": {
      "main": [
        [
          {
            "node": "Связывание",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Связывание": {
      "main": [
        [
          {
            "node": "Есть сообщение?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Есть сообщение?": {
      "main": [
        [
          {
            "node": "Параметры примечания",
            "type": "main",
            "index": 0
          },
          {
            "node": "Есть email?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Есть email?": {
      "main": [
        [
          {
            "node": "Данные письма",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Данные письма": {
      "main": [
        [
          {
            "node": "Отправка письма автору",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры примечания": {
      "main": [
        [
          {
            "node": "Добавление примечания",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Если демо контакт не существует": {
      "main": [
        [
          {
            "node": "Set1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры демо контакта": {
      "main": [
        [
          {
            "node": "Создание демо контакта",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Создание демо контакта": {
      "main": [
        [
          {
            "node": "ID демо контакта",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ID демо контакта": {
      "main": [
        [
          {
            "node": "Доболнительные параметры",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Доболнительные параметры": {
      "main": [
        [
          {
            "node": "Параметры демо сделки",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры демо сделки": {
      "main": [
        [
          {
            "node": "Новая демо сделка",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Новая демо сделка": {
      "main": [
        [
          {
            "node": "ID демо сделки",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Список демо товаров": {
      "main": [
        [
          {
            "node": "SplitInBatches1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Параметры демо счета",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ID демо сделки": {
      "main": [
        [
          {
            "node": "Сделка и демо контакт",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры привязки демо товара": {
      "main": [
        [
          {
            "node": "Привязка демо товара",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Привязка демо товара": {
      "main": [
        [
          {
            "node": "SplitInBatches1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Создание демо счета": {
      "main": [
        [
          {
            "node": "Демо счет",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры демо счета": {
      "main": [
        [
          {
            "node": "Создание демо счета",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Демо счет": {
      "main": [
        [
          {
            "node": "Демо сделка и демо счет",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Демо сделка и демо счет": {
      "main": [
        [
          {
            "node": "Связь счета и демо сделки",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Сделка и демо контакт": {
      "main": [
        [
          {
            "node": "Связывание демо",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Связывание демо": {
      "main": [
        [
          {
            "node": "ID товаров",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Связь счета и демо сделки": {
      "main": [
        [
          {
            "node": "Обновление демо данных",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set": {
      "main": [
        [
          {
            "node": "Execute Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set1": {
      "main": [
        [
          {
            "node": "Execute Workflow1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Workflow1": {
      "main": [
        [
          {
            "node": "Параметры демо контакта",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Данные автора",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set2": {
      "main": [
        [
          {
            "node": "Данные автора",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Данные автора": {
      "main": [
        [
          {
            "node": "Параметры  сделки",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ID товаров": {
      "main": [
        [
          {
            "node": "Набор индентификаторов",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Набор индентификаторов": {
      "main": [
        [
          {
            "node": "Список демо товаров",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SplitInBatches1": {
      "main": [
        [
          {
            "node": "Параметры привязки демо товара",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Данные пользователя": {
      "main": [
        [
          {
            "node": "Идентификатор созданого",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Параметры товара": {
      "main": [
        [
          {
            "node": "Данные товаров",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Данные товаров": {
      "main": [
        [
          {
            "node": "Список товаров",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SplitInBatches": {
      "main": [
        [
          {
            "node": "Параметры привязки товара",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2022-10-28T19:21:32.910Z",
  "hash": "24c6c7172becba4a14751915c9b41d4e",
  "id": 12,
  "name": "Prod: Market Events",
  "nodes": [
    {
      "parameters": {
        "workflowId": "13"
      },
      "id": "9e70d19d-3f2e-48f4-aec9-11a0b428839d",
      "name": "Execute Workflow",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        -820,
        720
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ff15db6a-ff62-468e-a2e6-6b171b1d7e46",
        "options": {}
      },
      "id": "bac9c597-0b38-4520-900e-fbd446601b6f",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -1180,
        720
      ],
      "webhookId": "ff15db6a-ff62-468e-a2e6-6b171b1d7e46"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow\"].json[\"subdomain\"]}}/api/v4/contacts",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Параметры контакта\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "ea16f019-18d7-428b-bf9b-05cf66c2fceb",
      "name": "Создание контакта",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        160,
        560
      ]
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "create",
        "projectId": "p_f907ih5oqn9gtp",
        "table": "md_n1yyob6hvv0plw",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "contact_id",
              "fieldValue": "={{$node[\"ID контакта\"].json[\"data\"][\"_embedded\"][\"contacts\"][0][\"id\"]}}"
            },
            {
              "fieldName": "first_name",
              "fieldValue": "={{$node[\"Webhook\"].json[\"body\"][\"Name\"]}}"
            },
            {
              "fieldName": "email",
              "fieldValue": "={{$node[\"Webhook\"].json[\"body\"][\"Email\"]}}"
            },
            {
              "fieldName": "phone_number",
              "fieldValue": "={{$node[\"Webhook\"].json[\"body\"][\"Phone\"]}}"
            },
            {
              "fieldName": "balance",
              "fieldValue": "0"
            },
            {
              "fieldName": "stage",
              "fieldValue": "регистрация"
            }
          ]
        }
      },
      "id": "f988f190-e26f-411c-a712-8321202529d8",
      "name": "Добавление пользователя",
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 2,
      "position": [
        540,
        560
      ],
      "credentials": {
        "nocoDbApiToken": {
          "id": "3",
          "name": "NocoDB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "let params = [{\n  \"first_name\": $node[\"Webhook\"].json[\"body\"][\"Name\"],\n  \"responsible_user_id\": 289686,\n  \"custom_fields_values\": [\n    {\n      \"field_id\": 763227,\n      \"values\": [\n        {\n          \"value\": $node[\"Webhook\"].json[\"body\"][\"Email\"],\n          \"enum_id\": 570365\n        }\n      ]\n    }\n  ]\n}]\n\nif ($node[\"Webhook\"].json[\"body\"][\"Phone\"]) {\n  params[0][\"custom_fields_values\"].push(\n    {\n      \"field_id\": 763225,\n      \"values\": [\n        {\n          \"value\": $node[\"Webhook\"].json[\"body\"][\"Phone\"],\n          \"enum_id\": 570353\n        }\n      ]\n    }\n  )\n}\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "a4f5bf4d-c7ed-4f48-93fa-179495692ebd",
      "name": "Параметры контакта",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -20,
        560
      ]
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    data: JSON.parse($input.all()[0].json.data)\n  }\n];"
      },
      "id": "bf7256e5-5de6-4798-b799-5cf4157735fd",
      "name": "ID контакта",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        340,
        560
      ]
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "projectId": "p_f907ih5oqn9gtp",
        "table": "md_n1yyob6hvv0plw",
        "limit": 1,
        "options": {
          "where": "=(email,eq,{{$node[\"Webhook\"].json[\"body\"][\"Email\"]}})"
        }
      },
      "id": "844923bd-4633-4546-979f-5423447c41f4",
      "name": "Поиск пользователя",
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 2,
      "position": [
        -640,
        720
      ],
      "alwaysOutputData": true,
      "credentials": {
        "nocoDbApiToken": {
          "id": "3",
          "name": "NocoDB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    json: {\n      empty: $input.all().length == 1 && Object.keys($input.all()[0].json).length == 0\n    }\n  }\n];"
      },
      "id": "ff9a4af7-aa77-4c7d-be3d-728ffd52f777",
      "name": "Результат поиска",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -460,
        720
      ]
    },
    {
      "parameters": {
        "values": {
          "number": [
            {
              "name": "contact_id",
              "value": "={{$node[\"Поиск пользователя\"].json[\"contact_id\"]}}"
            },
            {
              "name": "demo_contact_id",
              "value": "={{$node[\"Поиск пользователя\"].json[\"demo_contact_id\"]}}"
            },
            {
              "name": "user_id",
              "value": "={{$node[\"Поиск пользователя\"].json[\"user_id\"]}}"
            },
            {
              "name": "demo_lead_id",
              "value": "={{$node[\"Поиск пользователя\"].json[\"demo_lead_id\"]}}"
            },
            {
              "name": "record_id",
              "value": "={{$node[\"Поиск пользователя\"].json[\"Id\"]}}"
            },
            {
              "name": "lead_id",
              "value": "={{$node[\"Поиск пользователя\"].json[\"lead_id\"]}}"
            },
            {
              "name": "demo_id",
              "value": "={{$node[\"Поиск пользователя\"].json[\"demo_id\"]}}"
            }
          ]
        },
        "options": {}
      },
      "id": "c62caafb-6f40-4688-afcc-310cff21fbac",
      "name": "Идентификатор найденного",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        440,
        880
      ]
    },
    {
      "parameters": {
        "values": {
          "number": [
            {
              "name": "contact_id",
              "value": "={{$node[\"Данные пользователя\"].json[\"contact_id\"]}}"
            },
            {
              "name": "demo_contact_id",
              "value": "={{null}}"
            },
            {
              "name": "user_id",
              "value": "={{null}}"
            },
            {
              "name": "demo_lead_id",
              "value": "={{null}}"
            },
            {
              "name": "record_id",
              "value": "={{$node[\"Данные пользователя\"].json[\"id\"]}}"
            },
            {
              "name": "lead_id",
              "value": "={{null}}"
            },
            {
              "name": "demo_id",
              "value": "={{$node[\"Данные пользователя\"].json[\"demo_id\"]}}"
            }
          ]
        },
        "options": {}
      },
      "id": "7f3978ef-5d5e-437d-99eb-1aa0c6baa897",
      "name": "Идентификатор созданого",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        900,
        560
      ]
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    data: $input.all()[0].json\n  }\n];"
      },
      "id": "bf7f674a-87d4-44de-bfe9-00dded829c28",
      "name": "ID пользователя",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        1160,
        720
      ]
    },
    {
      "parameters": {
        "jsCode": "let products = $node[\"Webhook\"].json[\"body\"][\"payment\"][\"products\"];\nlet result = [];\n\nfor (let i = 0; i < products.length; i++) {\n  products[i]\n  result.push(`${i + 1}. ${products[i].name} - ${products[i].quantity} шт. / ${products[i].price}`)\n}\n\nreturn [{ products: result.join('\\n') }];"
      },
      "id": "939ebad3-e54e-40f6-bb14-7dcc06ca7ad4",
      "name": "Товары",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        1680,
        -240
      ]
    },
    {
      "parameters": {
        "jsCode": "let params = [\n  {\n    \"name\": `Заказ № ${$node[\"Webhook\"].json[\"body\"][\"payment\"][\"orderid\"]}`,\n    \"price\": parseInt($node[\"Webhook\"].json[\"body\"][\"payment\"][\"amount\"]),\n    \"responsible_user_id\": 289686,\n    \"status_id\": 39207736,\n    \"pipeline_id\": 4163434,\n    \"custom_fields_values\": [\n      {\n        \"field_id\": 889027,\n        \"values\": [\n          {\n            \"value\": $node[\"Товары\"].json.products\n          }\n        ]\n      }\n    ]\n  }\n]\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "d33b970f-fba8-4e8a-a600-4799de544d6c",
      "name": "Параметры создания сделки",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        1860,
        -240
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow\"].json[\"subdomain\"]}}/api/v4/leads",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Параметры создания сделки\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "203ca13d-281b-480c-8e1a-23980f336dd4",
      "name": "Создание сделки",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        2040,
        -240
      ]
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    data: JSON.parse($input.all()[0].json.data)\n  }\n];"
      },
      "id": "c119ec1a-ac6b-4460-8823-c9c6b0e1925f",
      "name": "Ответ создания",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2220,
        -240
      ]
    },
    {
      "parameters": {
        "jsCode": "let params = [\n  {\n    \"entity_id\": parseInt($node[\"Ответ создания\"].json[\"data\"][\"_embedded\"][\"leads\"][0][\"id\"]),\n    \"to_entity_id\": parseInt($node[\"ID пользователя\"].json[\"data\"][\"contact_id\"]),\n    \"to_entity_type\": \"contacts\",\n    \"metadata\": {\n      \"is_main\": true\n    }\n  }\n]\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "6aa200d9-53b3-4b7f-84d3-5f54a444b227",
      "name": "Параметры связывания контакта",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2400,
        -240
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$node[\"Результат поиска\"].json[\"empty\"]}}",
              "operation": "notEqual"
            }
          ]
        }
      },
      "id": "40a13954-d98c-4a77-ab50-2c7a105c5d62",
      "name": "Пользователь не найден?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -280,
        720
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$node[\"Webhook\"].json[\"body\"][\"formid\"]}}",
              "value2": "form377580437"
            }
          ]
        }
      },
      "id": "59a87619-7b1f-440d-acb9-2bdbfed111ba",
      "name": "Покупка шаблона?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1420,
        160
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow\"].json[\"subdomain\"]}}/api/v4/leads/link",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Параметры связывания контакта\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "bd6cd52e-1e73-46b5-a9a0-4459b5868082",
      "name": "Связывание сделки и контакта",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        2580,
        -240
      ]
    },
    {
      "parameters": {
        "jsCode": "return $node[\"Webhook\"].json[\"body\"][\"payment\"][\"products\"];"
      },
      "id": "2fec995c-c961-4e24-95cb-6ffb69edfd43",
      "name": "Список товаров",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3120,
        -240
      ]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "99de6e7e-be8a-48ae-a6ab-d0e454c92e7e",
      "name": "SplitInBatches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [
        3380,
        -400
      ],
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "\nlet params = [\n  {\n    \"entity_id\": parseInt($node[\"Ответ создания\"].json[\"data\"][\"_embedded\"][\"leads\"][0][\"id\"]),\n    \"to_entity_id\": parseInt($node[\"SplitInBatches\"].json[\"externalid\"]),\n    \"to_entity_type\": \"catalog_elements\",\n    \"metadata\": {\n      \"quantity\": parseInt($node[\"SplitInBatches\"].json[\"quantity\"]),\n      \"catalog_id\": 4293\n    }\n  }\n]\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "72c22a1b-dc42-4624-ad93-ba9acf6eb0bf",
      "name": "Параметры привязки товара",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3560,
        -400
      ]
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "projectId": "p_f907ih5oqn9gtp",
        "table": "md_t8cq3zpwwv80h2",
        "returnAll": true,
        "options": {}
      },
      "id": "b916ce74-c986-4476-8c48-97e897de8bf1",
      "name": "Параметры товара",
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 2,
      "position": [
        2760,
        -240
      ],
      "credentials": {
        "nocoDbApiToken": {
          "id": "3",
          "name": "NocoDB"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow\"].json[\"subdomain\"]}}/api/v4/leads/link",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Параметры привязки товара\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "a0f95dd6-719d-42cb-afac-73f11fb6790b",
      "name": "Привязка товара",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        3740,
        -400
      ]
    },
    {
      "parameters": {
        "jsCode": "let goodsData = $node[\"Данные товаров\"].json[$node[\"SplitInBatches\"].json[\"externalid\"]];\n\nlet params = {\n  user_name: $node[\"Webhook\"].json[\"body\"][\"Name\"],\n  template_name: $node[\"SplitInBatches\"].json[\"name\"],\n  download_url: `https://app.mybi.ru/market/download/${goodsData.code}`,\n  support_url: goodsData.support_url\n}\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "02ab6397-73cb-4e29-8670-9efa13bb322d",
      "name": "Параметры письма",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3920,
        -400
      ]
    },
    {
      "parameters": {
        "url": "http://api.dashamail.com",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "method",
              "value": "transactional.send"
            },
            {
              "name": "api_key",
              "value": "0f0ca3c6f479fd2fab67384e9e5c15d1"
            },
            {
              "name": "to",
              "value": "={{$node[\"Webhook\"].json[\"body\"][\"Email\"]}}"
            },
            {
              "name": "message",
              "value": "2287063"
            },
            {
              "name": "from_email",
              "value": "mail@mybi.ru"
            },
            {
              "name": "subject",
              "value": "={{$node[\"SplitInBatches\"].json[\"name\"]}}"
            },
            {
              "name": "template_data",
              "value": "={{$node[\"Параметры письма\"].json[\"params\"]}}"
            },
            {
              "name": "from_name",
              "value": "Алексей Сидоров"
            }
          ]
        },
        "options": {}
      },
      "id": "c08f4442-b664-4723-b7c8-7431a3ae52a5",
      "name": "Отправка письма",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        4100,
        -400
      ]
    },
    {
      "parameters": {
        "jsCode": "let goodsData = $node[\"Данные товаров\"].json[$node[\"SplitInBatches\"].json[\"externalid\"]];\n\nlet params = {\n  user_id: parseInt(goodsData.user_id),\n  amount: parseInt($node[\"SplitInBatches\"].json[\"amount\"]),\n  comment: `Продажа отчета ${$node[\"SplitInBatches\"].json[\"name\"]}`\n}\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "04784cd1-bc77-48ac-85dc-0e222b13ee6e",
      "name": "Параметры myBI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        4280,
        -400
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.mybi.ru/payments/market/callback",
        "sendQuery": true,
        "specifyQuery": "json",
        "jsonQuery": "={{$node[\"Параметры myBI\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "9bb0c18e-aa58-4870-88ae-f6f1e6c093f5",
      "name": "Отправка webhook",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        4460,
        -400
      ]
    },
    {
      "parameters": {
        "jsCode": "let products = [];\nlet data = $input.all();\n\n\n\nfor (let i = 0; i < data.length; i++) {\n  let goodsData = $node[\"Данные товаров\"].json[data[i].json[\"externalid\"]];\n  \n  products.push({\n    \"value\": {\n      \"sku\": goodsData.code,\n      \"product_id\": parseInt(data[i].json[\"externalid\"]),\n      \"description\": data[i].json[\"name\"],\n      \"unit_price\": parseFloat(data[i].json[\"price\"]),\n      \"unit_type\": \"шт\",\n      \"quantity\": data[i].json[\"quantity\"]\n    }\n  })\n}\n\nlet params = [{\n  \"name\": `Покупка № ${$node[\"Webhook\"].json[\"body\"][\"payment\"][\"orderid\"]}`,\n  \"custom_fields_values\": [\n    {\n      \"field_id\": 1158437,\n      \"values\": [\n        {\n          \"value\": \"Оплачен\"\n        }\n      ]\n    },\n    {\n      \"field_id\": 1158441,\n      \"values\": [\n        {\n          \"value\": {\n            \"entity_id\": parseInt($node[\"ID пользователя\"].json[\"data\"][\"contact_id\"]),\n            \"entity_type\": \"contacts\"\n          }\n        }\n      ]\n    },\n    {\n      \"field_id\": 1158445,\n      \"field_name\": \"Дата оплаты\",\n      \"values\": [\n        {\n          \"value\": parseInt(new Date().getTime() / 1000)\n        }\n      ]\n    },\n    {\n      \"field_id\": 1158447,\n      \"values\": products\n    },\n    {\n      \"field_id\": 1158451,\n      \"field_name\": \"Стоимость\",\n      \"values\": [\n        {\n          \"value\": $node[\"Webhook\"].json[\"body\"][\"payment\"][\"amount\"]\n        }\n      ]\n    },\n    {\n      \"field_id\": 1158449,\n      \"values\": [\n        {\n          \"value\": $node[\"Webhook\"].json[\"body\"][\"payment\"][\"sys\"]\n        }\n      ]\n    },\n    {\n      \"field_id\": 1158455,\n      \"values\": [\n        {\n          \"value\": $node[\"Webhook\"].json[\"body\"][\"payment\"][\"systranid\"]\n        }\n      ]\n    }\n  ]\n}];\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "a413e29e-19d7-4d9d-afcf-d51d8a913dec",
      "name": "Параметры счета",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3380,
        -80
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow\"].json[\"subdomain\"]}}/api/v4/catalogs/9477/elements",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Параметры счета\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "ca38288e-d696-4743-9884-c2aa8faf9e4b",
      "name": "Создание счета",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        3560,
        -80
      ]
    },
    {
      "parameters": {
        "jsCode": "return [{ data: JSON.parse($input.all()[0].json.data) }];"
      },
      "id": "21f44c14-131b-4c93-8d35-54dbc74407dd",
      "name": "Счет",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3740,
        -80
      ]
    },
    {
      "parameters": {
        "jsCode": "let params = [\n  {\n    \"entity_id\": parseInt($node[\"Ответ создания\"].json[\"data\"][\"_embedded\"][\"leads\"][0][\"id\"]),\n    \"to_entity_id\": parseInt($node[\"Счет\"].json[\"data\"][\"_embedded\"][\"elements\"][0][\"id\"]),\n    \"to_entity_type\": \"catalog_elements\",\n    \"metadata\": {\n      \"quantity\": 1.0,\n      \"catalog_id\": 9477\n    }\n  }\n]\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "0febc4b3-e82b-4af8-9760-7914034e7909",
      "name": "Сделка и счет",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3920,
        -80
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow\"].json[\"subdomain\"]}}/api/v4/leads/link",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Сделка и счет\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "9dc4b8a9-fef5-4b01-afb7-995e31adcd81",
      "name": "Связь счета и сделки",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        4100,
        -80
      ]
    },
    {
      "parameters": {
        "jsCode": "let params = [\n  {\n    \"id\": parseInt($node[\"Ответ создания\"].json[\"data\"][\"_embedded\"][\"leads\"][0][\"id\"]),\n    \"responsible_user_id\": 289686,\n    \"status_id\": 40402399,\n    \"pipeline_id\": 4163434\n  }\n]\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "87b43af3-a09d-4fdd-8a91-d99bfb0381d6",
      "name": "Параметры обновления сделки",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        4280,
        -80
      ]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://{{$node[\"Execute Workflow\"].json[\"subdomain\"]}}/api/v4/leads",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Параметры обновления сделки\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "ff26b146-a5e4-4f8f-ad95-582f44d58e53",
      "name": "Обновление сделки",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        4460,
        -80
      ]
    },
    {
      "parameters": {
        "jsCode": "let forms = {\n  \"form380230425\": 2127,\n  \"form380227161\": 1773,\n  \"form380230802\": 953,\n  \"form380229840\": 3360,\n  \"form378881585\": 2954,\n  \"form380231530\": 4067,\n  \"form386679150\": 4819,\n  \"form382311757\": null,\n  \"form382311386\": null\n}\n\nlet data = [{ value: forms[$node[\"Webhook\"].json[\"body\"][\"formid\"]] }]\n\nreturn data;"
      },
      "id": "de0e32a1-41e6-4045-928c-618fd87d7654",
      "name": "ID формы обращения",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        1680,
        560
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$node[\"ID формы обращения\"].json[\"value\"]}}",
              "operation": "notEqual",
              "value2": "={{null}}"
            }
          ]
        }
      },
      "id": "bdb8b35b-c934-422d-b384-872aee534a8d",
      "name": "ID пользователя определен?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1860,
        560
      ]
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "projectId": "p_f907ih5oqn9gtp",
        "table": "md_n1yyob6hvv0plw",
        "limit": 1,
        "options": {
          "where": "=(user_id,eq,{{$node[\"ID формы обращения\"].json[\"value\"]}})"
        }
      },
      "id": "2add5393-3da3-49b4-98f6-d3b89826dd20",
      "name": "Поиск автора",
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 2,
      "position": [
        2120,
        400
      ],
      "credentials": {
        "nocoDbApiToken": {
          "id": "3",
          "name": "NocoDB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "let params = [\n  {\n    \"name\": $node[\"Webhook\"].json[\"body\"][\"Name\"],\n    \"responsible_user_id\": 289686,\n    \"status_id\": 44373853,\n    \"pipeline_id\": 4901218\n  }\n]\n\nif ($input.first().json['data']['fullName'] != null) {\n  params[0][\"custom_fields_values\"] = [\n    {\n      \"field_id\": 1158461,\n      \"values\": [\n        {\n          \"value\": $input.first().json['data']['fullName']\n        }\n      ]\n    }\n  ]\n}\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "13b904c5-ad88-4ad4-9129-36b9cc2b1cd2",
      "name": "Параметры  сделки",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2760,
        560
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow\"].json[\"subdomain\"]}}/api/v4/leads",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Параметры  сделки\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "0e7ea7d2-1965-43aa-a217-21303d59bce5",
      "name": "Новая сделка",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        2940,
        560
      ]
    },
    {
      "parameters": {
        "jsCode": "return [{ data: JSON.parse($input.all()[0].json.data) }];"
      },
      "id": "c29c3f80-560f-49a8-a453-8f689a885d5a",
      "name": "Данные о сделке",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3120,
        560
      ]
    },
    {
      "parameters": {
        "jsCode": "let params = [\n  {\n    \"entity_id\": parseInt($node[\"Данные о сделке\"].json[\"data\"][\"_embedded\"][\"leads\"][0][\"id\"]),\n    \"to_entity_id\": parseInt($node[\"ID пользователя\"].json[\"data\"][\"contact_id\"]),\n    \"to_entity_type\": \"contacts\",\n    \"metadata\": {\n      \"is_main\": true\n    }\n  }\n]\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "d4baa8ed-7686-4399-9a8e-033473f523e9",
      "name": "Сделка и контакт",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3300,
        560
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow\"].json[\"subdomain\"]}}/api/v4/leads/link",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Сделка и контакт\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "fe8bc904-d25a-4283-ac8a-d0d1925a563b",
      "name": "Связывание",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        3480,
        560
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$node[\"Webhook\"].json[\"body\"][\"Task_info\"]}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "0c2617a5-2570-4ed9-8b39-86f4cdf351d4",
      "name": "Есть сообщение?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        3660,
        560
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$node[\"Данные автора\"].json[\"email\"]}}",
              "operation": "notEqual",
              "value2": "={{null}}"
            }
          ]
        }
      },
      "id": "ab061483-1ff9-4f96-bd09-f0c1b11a8e33",
      "name": "Есть email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        3900,
        380
      ]
    },
    {
      "parameters": {
        "jsCode": "let description = `${$node[\"Webhook\"].json[\"body\"][\"Task_info\"]} \\n\\nИсточник данных: ${$node[\"Webhook\"].json[\"body\"][\"Data_source\"]}`;\n\nlet params = {\n  user_name: $node[\"Данные автора\"].json[\"data\"][\"fullName\"],\n  client_name: $node[\"Webhook\"].json[\"body\"][\"Name\"],\n  client_phone: $node[\"Webhook\"].json[\"body\"][\"Phone\"],\n  client_email: $node[\"Webhook\"].json[\"body\"][\"Email\"],\n  description: description\n}\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "5c64bb24-9606-42bb-b43b-bf3a2b3825f0",
      "name": "Данные письма",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        4180,
        220
      ]
    },
    {
      "parameters": {
        "url": "http://api.dashamail.com",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "method",
              "value": "transactional.send"
            },
            {
              "name": "api_key",
              "value": "0f0ca3c6f479fd2fab67384e9e5c15d1"
            },
            {
              "name": "to",
              "value": "={{$node[\"Поиск автора\"].json[\"email\"]}}"
            },
            {
              "name": "message",
              "value": "2286604"
            },
            {
              "name": "from_email",
              "value": "mail@mybi.ru"
            },
            {
              "name": "subject",
              "value": "Обращение"
            },
            {
              "name": "template_data",
              "value": "={{$node[\"Данные письма\"].json[\"params\"]}}"
            }
          ]
        },
        "options": {}
      },
      "id": "22e7a47d-6257-42fc-93e5-ac7766cf43c9",
      "name": "Отправка письма автору",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        4360,
        220
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow\"].json[\"subdomain\"]}}/api/v4/leads/notes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Параметры примечания\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "457a14fc-fea5-4358-8bdd-f40c34a5366a",
      "name": "Добавление примечания",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        4080,
        700
      ]
    },
    {
      "parameters": {
        "jsCode": "let text = `${$node[\"Webhook\"].json[\"body\"][\"Task_info\"]} \\n\\nИсточник данных: ${$node[\"Webhook\"].json[\"body\"][\"Data_source\"]}`;\n\nlet params = [\n  {\n    \"entity_id\": parseInt($node[\"Данные о сделке\"].json[\"data\"][\"_embedded\"][\"leads\"][0][\"id\"]),\n    \"note_type\": \"common\",\n    \"params\": {\n      \"text\": text\n    }\n  }\n]\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "fc1e84b4-74b4-4a22-8e64-8ac137614540",
      "name": "Параметры примечания",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3900,
        700
      ]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$node[\"ID пользователя\"].json[\"data\"][\"user_id\"]}}",
              "operation": "equal",
              "value2": "={{null}}"
            }
          ],
          "string": [
            {
              "value1": "={{$node[\"Webhook\"].json[\"body\"][\"formid\"]}}",
              "value2": "form377580437"
            }
          ]
        }
      },
      "id": "57635d70-c1e3-41df-b8ea-27280510367a",
      "name": "Если демо контакт не существует",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1420,
        1300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow1\"].json[\"subdomain\"]}}/api/v4/contacts",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow1\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Параметры демо контакта\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "e60ce212-8c39-4efb-90b0-1664ab30dcf3",
      "name": "Создание демо контакта",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        2220,
        1140
      ]
    },
    {
      "parameters": {
        "jsCode": "let demo_id = $node[\"ID пользователя\"].json[\"data\"][\"demo_id\"];\nlet params = [{\n  \"first_name\": `Покупатель № ${demo_id}`,\n  \"responsible_user_id\": 289686,\n  \"custom_fields_values\": [\n    {\n      \"field_id\": 556273,\n      \"values\": [\n        {\n          \"value\": `${demo_id}@example.com`,\n          \"enum_id\": 374317,\n        }\n      ]\n    },\n    {\n      \"field_id\": 556271,\n      \"values\": [\n        {\n          \"value\": `+7 (000) 000-${demo_id}`,\n          \"enum_id\": 374305,\n        }\n      ]\n    }\n  ]\n}];\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "3793e0a3-25b9-41e3-83d8-675ecf00ea4c",
      "name": "Параметры демо контакта",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2040,
        1140
      ]
    },
    {
      "parameters": {
        "jsCode": "return [{ data: JSON.parse($input.all()[0].json.data) }];"
      },
      "id": "29be85a2-627c-40f6-b8aa-d44dc48ad252",
      "name": "ID демо контакта",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2400,
        1140
      ]
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field\n// called 'myNewField' to the JSON of each one\nlet COOKIES = $node[\"Webhook\"].json[\"body\"][\"COOKIES\"];\nlet list = COOKIES.split(\" \");\nlet ga = \"\";\n\nfor (const item of list) {\n  if(item.includes(\"_ga=\")) {\n    ga = item.substring(10, item.length-1);\n    break;\n  }\n}\n\nvar date = new Date();\nvar marker = `${date.getFullYear()}${date.getMonth()+1}-${$node[\"Webhook\"].json[\"body\"][\"payment\"][\"orderid\"]}`;\n\n\nreturn [{ga, marker}];"
      },
      "id": "782fed22-7430-437f-94a6-8f0b7f6c87f8",
      "name": "Доболнительные параметры",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2580,
        1140
      ]
    },
    {
      "parameters": {
        "jsCode": "let params = [\n  {\n    \"name\": `Заказ № ${$node[\"Webhook\"].json[\"body\"][\"payment\"][\"orderid\"]}`,\n    \"responsible_user_id\": 289686,\n    \"status_id\": 50286925,\n    \"pipeline_id\": 5723533,\n    \"custom_fields_values\": [\n      {\n        \"field_id\": 837471,\n        \"values\": [\n          {\n            \"value\": $node[\"Доболнительные параметры\"].json[\"ga\"]\n          }\n        ]\n      },\n      {\n        \"field_id\": 837469,\n        \"values\": [\n          {\n            \"value\": $node[\"Доболнительные параметры\"].json[\"marker\"]\n          }\n        ]\n      }\n    ]\n  }\n]\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "7b8e0f05-6676-42f2-a515-f0eac97dce6d",
      "name": "Параметры демо сделки",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2760,
        1140
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow1\"].json[\"subdomain\"]}}/api/v4/leads",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow1\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Параметры демо сделки\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "fc5619ad-56be-4fe9-ad12-73275a78f615",
      "name": "Новая демо сделка",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        2940,
        1140
      ]
    },
    {
      "parameters": {
        "jsCode": "return $node[\"Webhook\"].json[\"body\"][\"payment\"][\"products\"];"
      },
      "id": "c3634051-522e-427e-ba03-584689285dc9",
      "name": "Список демо товаров",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        4020,
        1140
      ]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "b8639a1d-3d96-4e7c-8499-c9edd24901d7",
      "name": "SplitInBatches1",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [
        4280,
        980
      ],
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "return [{ data: JSON.parse($input.all()[0].json.data) }];"
      },
      "id": "f163bd46-654c-4bde-b06c-b84d2c70d092",
      "name": "ID демо сделки",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3120,
        1140
      ]
    },
    {
      "parameters": {
        "jsCode": "let entity_id = $node[\"Набор индентификаторов\"].json[$node[\"SplitInBatches1\"].json[\"externalid\"]]\n\nlet params = [\n  {\n    \"entity_id\": parseInt($node[\"ID демо сделки\"].json[\"data\"][\"_embedded\"][\"leads\"][0][\"id\"]),\n    \"to_entity_id\": entity_id,\n    \"to_entity_type\": \"catalog_elements\",\n    \"metadata\": {\n      \"quantity\": parseInt($node[\"SplitInBatches1\"].json[\"quantity\"]),\n      \"catalog_id\": 6919\n    }\n  }\n]\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "07e9099e-0c06-4f25-b220-986fd7953ca7",
      "name": "Параметры привязки демо товара",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        4460,
        980
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow1\"].json[\"subdomain\"]}}/api/v4/leads/link",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow1\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Параметры привязки демо товара\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "9145324f-ee33-46b0-80aa-9688cb69ed37",
      "name": "Привязка демо товара",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        4640,
        980
      ]
    },
    {
      "parameters": {
        "jsCode": "let products = [];\nlet data = $input.all();\n\nlet product_ids = $node[\"Набор индентификаторов\"].json\n\nfor (let i = 0; i < data.length; i++) {\n  products.push({\n    \"value\": {\n      \"sku\": \"\",\n      \"product_id\": product_ids[data[i].json[\"externalid\"]],\n      \"description\": data[i].json[\"name\"],\n      \"unit_price\": parseFloat(data[i].json[\"price\"]),\n      \"unit_type\": \"шт\",\n      \"quantity\": data[i].json[\"quantity\"]\n    }\n  })\n}\n\nlet params = [{\n  \"name\": `\"Покупка № ${$node[\"Webhook\"].json[\"body\"][\"payment\"][\"orderid\"]}`,\n  \"custom_fields_values\": [\n    {\n      \"field_id\": 770089,\n      \"values\": [\n        {\n          \"value\": \"Оплачен\"\n        }\n      ]\n    },\n    {\n      \"field_id\": 770093,\n      \"values\": [\n        {\n          \"value\": {\n            \"entity_id\": parseInt($node[\"ID демо контакта\"].json[\"data\"][\"_embedded\"][\"contacts\"][0][\"id\"]),\n            \"entity_type\": \"contacts\",\n            \"catalog_id\": null\n          }\n        }\n      ]\n    },\n    {\n      \"field_id\": 770097,\n      \"values\": [\n        {\n          \"value\": parseInt(new Date().getTime() / 1000)\n        }\n      ]\n    },\n    {\n      \"field_id\": 770099,\n      \"values\": products\n    },\n    {\n      \"field_id\": 770103,\n      \"values\": [\n        {\n          \"value\": $node[\"Webhook\"].json[\"body\"][\"payment\"][\"amount\"]\n        }\n      ]\n    }\n  ]\n}];\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "4db5f042-c221-4d96-9a61-a0bb09cc9a46",
      "name": "Параметры демо счета",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        4280,
        1300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow1\"].json[\"subdomain\"]}}/api/v4/catalogs/6923/elements",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow1\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Параметры демо счета\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "bb740205-34d9-4093-b93e-cf9483fd3511",
      "name": "Создание демо счета",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        4460,
        1300
      ]
    },
    {
      "parameters": {
        "jsCode": "return [{ data: JSON.parse($input.all()[0].json.data) }];"
      },
      "id": "798a2268-b19e-4224-beb0-527a53bf8f08",
      "name": "Демо счет",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        4640,
        1300
      ]
    },
    {
      "parameters": {
        "jsCode": "let params = [\n  {\n    \"entity_id\": parseInt($node[\"ID демо сделки\"].json[\"data\"][\"_embedded\"][\"leads\"][0][\"id\"]),\n    \"to_entity_id\": parseInt($node[\"Демо счет\"].json[\"data\"][\"_embedded\"][\"elements\"][0][\"id\"]),\n    \"to_entity_type\": \"catalog_elements\",\n    \"metadata\": {\n      \"quantity\": 1.0,\n      \"catalog_id\": 6923\n    }\n  }\n]\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "2cad9187-555c-4967-af11-b10e30534c51",
      "name": "Демо сделка и демо счет",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        4820,
        1300
      ]
    },
    {
      "parameters": {
        "jsCode": "let params = [\n  {\n    \"entity_id\": parseInt($node[\"ID демо сделки\"].json[\"data\"][\"_embedded\"][\"leads\"][0][\"id\"]),\n    \"to_entity_id\": parseInt($node[\"ID демо контакта\"].json[\"data\"][\"_embedded\"][\"contacts\"][0][\"id\"]),\n    \"to_entity_type\": \"contacts\",\n    \"metadata\": {\n      \"is_main\": true\n    }\n  }\n]\n\nreturn [{ params: JSON.stringify(params) }];"
      },
      "id": "e1e21e18-4ed9-44cd-9b68-bba67b642bca",
      "name": "Сделка и демо контакт",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3300,
        1140
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow1\"].json[\"subdomain\"]}}/api/v4/leads/link",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow1\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Сделка и демо контакт\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "8e467b1d-5a4d-4fe1-9436-d8785eba9573",
      "name": "Связывание демо",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        3480,
        1140
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$node[\"Execute Workflow1\"].json[\"subdomain\"]}}/api/v4/leads/link",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$node[\"Execute Workflow1\"].json[\"access_token\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$node[\"Демо сделка и демо счет\"].json[\"params\"]}}",
        "options": {}
      },
      "id": "1a577b23-db93-4d91-935d-bf2164fb344b",
      "name": "Связь счета и демо сделки",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        5000,
        1300
      ]
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "update",
        "projectId": "p_f907ih5oqn9gtp",
        "table": "md_n1yyob6hvv0plw",
        "id": "={{$node[\"ID пользователя\"].json[\"data\"][\"record_id\"]}}",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "demo_lead_id",
              "fieldValue": "={{$node[\"ID демо сделки\"].json[\"data\"][\"_embedded\"][\"leads\"][0][\"id\"]}}"
            },
            {
              "fieldName": "demo_contact_id",
              "fieldValue": "={{$node[\"ID демо контакта\"].json[\"data\"][\"_embedded\"][\"contacts\"][0][\"id\"]}}"
            }
          ]
        }
      },
      "id": "fbf4d407-4c2b-47b8-9985-c9e09522ceca",
      "name": "Обновление демо данных",
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 2,
      "position": [
        5180,
        1300
      ],
      "credentials": {
        "nocoDbApiToken": {
          "id": "3",
          "name": "NocoDB"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "amoType",
              "value": "prod"
            }
          ]
        },
        "options": {}
      },
      "id": "273a2ea9-23cb-4199-814a-54dad8f6e990",
      "name": "Set",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        -1000,
        720
      ]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "amoType",
              "value": "demo"
            }
          ]
        },
        "options": {}
      },
      "id": "79aa201c-53ae-4bd7-bf62-6bd94597cc23",
      "name": "Set1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        1680,
        1140
      ]
    },
    {
      "parameters": {
        "workflowId": "13"
      },
      "id": "c67b66e5-0b57-43be-9b9f-a165959be9ec",
      "name": "Execute Workflow1",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        1860,
        1140
      ]
    },
    {
      "parameters": {
        "jsCode": "let email = $node[\"Поиск автора\"].json[\"email\"];\nlet fullName = $node[\"Поиск автора\"].json[\"first_name\"];\n\nif ($node[\"Поиск автора\"].json[\"last_name\"]) {\n  fullName += \" \" + $node[\"Поиск автора\"].json[\"last_name\"]\n}\n\nreturn [{ fullName, email }];"
      },
      "id": "0238e02e-81b4-459e-8fef-40d91fb755c7",
      "name": "Code",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2320,
        400
      ]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "fullName",
              "value": "={{null}}"
            },
            {
              "name": "email",
              "value": "={{null}}"
            }
          ]
        },
        "options": {}
      },
      "id": "8ecf922d-dd01-46c4-9170-ca72896030f7",
      "name": "Set2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        2220,
        720
      ]
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    data: $input.all()[0].json\n  }\n];"
      },
      "id": "c037b949-50c4-4d0a-9155-6cf9175dbb13",
      "name": "Данные автора",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2580,
        560
      ]
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "projectId": "p_f907ih5oqn9gtp",
        "table": "md_0sbwwkhz6h64f3",
        "returnAll": true,
        "options": {}
      },
      "id": "81138475-b6d1-41ad-9bf2-991ff5550d10",
      "name": "ID товаров",
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 2,
      "position": [
        3660,
        1140
      ],
      "credentials": {
        "nocoDbApiToken": {
          "id": "3",
          "name": "NocoDB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "let mapping = {}\n\nfor (const item of $input.all()) {\n  mapping[item.json.product_id] = parseInt(item.json.demo_product_id);\n}\n\nreturn mapping;"
      },
      "id": "66464483-2216-4d5e-bf0d-c113ee51825b",
      "name": "Набор индентификаторов",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        3840,
        1140
      ]
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "projectId": "p_f907ih5oqn9gtp",
        "table": "md_n1yyob6hvv0plw",
        "id": "={{$node[\"Добавление пользователя\"].json[\"id\"]}}"
      },
      "id": "8f94c074-1e43-4d9e-9eae-d02b3ca97b1b",
      "name": "Данные пользователя",
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 2,
      "position": [
        720,
        560
      ],
      "credentials": {
        "nocoDbApiToken": {
          "id": "3",
          "name": "NocoDB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field\n// called 'myNewField' to the JSON of each one\nlet mapping = {}\n\nfor (const item of $input.all()) {\n  mapping[item.json.product_id] = {\n    user_id: parseInt(item.json.user_id),\n    support_url: item.json.support_url,\n    code: item.json.code\n  }\n}\n\nreturn mapping;\n"
      },
      "id": "732c2f2b-3d15-4eec-84e5-b78e99d16c04",
      "name": "Данные товаров",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        2940,
        -240
      ]
    }
  ],
  "pinData": {},
  "settings": {
    "saveExecutionProgress": "DEFAULT",
    "callerPolicy": "any",
    "errorWorkflow": "8"
  },
  "staticData": null,
  "tags": [],
  "updatedAt": "2022-11-10T13:38:53.269Z"
}